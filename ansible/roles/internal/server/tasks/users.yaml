---
- name: Ensure sudo package is installed
  ansible.builtin.apt:
    name: sudo
    state: present
    update_cache: true
  when: ansible_facts.os_family == "Debian"

- name: Ensure sudo group exists
  ansible.builtin.group:
    name: "{{ server_sudo_group }}"
    state: present
  when: ansible_facts.os_family == "Debian"

- name: Create users
  ansible.builtin.user:
    name: "{{ item.name }}"
    shell: "{{ item.shell | default(server_default_shell) }}"
    create_home: true
    state: "{{ item.state | default('present') }}"
    groups: >-
      {{
        ([server_sudo_group] if (item.sudo | default(false)) else [])
        + (item.extra_groups | default([]))
      }}
    append: true
    password: "{{ item.password | password_hash('sha256', 'mmmsalt') | default(omit) }}"
    password_lock: false
  loop: "{{ server_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Authorize SSH keys
  ansible.posix.authorized_key:
    user: "{{ item.0.name }}"
    key: "{{ item.1 }}"
    state: present
  loop: "{{ server_users | subelements('pubkeys', skip_missing=True) }}"
  loop_control:
    label: "{{ item.0.name }}"

- name: Configure passwordless sudo
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/90-{{ item.name }}"
    owner: root
    group: root
    mode: "0440"
    content: "{{ item.name }} ALL=(ALL) NOPASSWD:ALL\n"
    validate: "visudo -cf %s"
  when: item.sudo_nopasswd | default(false)
  loop: "{{ server_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Manage passwordless sudo file
  ansible.builtin.file:
    path: "/etc/sudoers.d/90-{{ item.name }}"
    state: "{{ 'file' if (item.sudo_nopasswd | default(false)) else 'absent' }}"
  loop: "{{ server_users }}"
  loop_control:
    label: "{{ item.name }}"

